<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ  ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª - Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --primary-dark: #5a6fd8; --secondary: #764ba2;
            --success: #28a745; --info: #17a2b8; --warning: #ffc107; --danger: #dc3545;
            --light: #f8f9fa; --dark: #343a40; --gray: #6c757d; --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.1); --radius: 12px; --transition: all 0.3s ease;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
            direction: rtl; padding: 20px; line-height: 1.6;
        }
        .container {
            background: var(--white); padding: 30px; border-radius: var(--radius);
            box-shadow: var(--shadow); width: 100%; max-width: 1200px; animation: slideIn 0.5s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ø³ØªØ§ÛŒÙ„ÛŒ ØªØ§ÛŒØ¨Û•Øª Ø¨Û† Ù„Û†Ú¯Û†ÛŒ Ú¯Û•ÙˆØ±Û•ØªØ± */
        .logo-container {
            text-align: center; margin-bottom: 25px; padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px; border: 3px solid rgba(102, 126, 234, 0.3);
        }
        .institute-logo {
            width: 800px; height: 120px; object-fit: contain;
            border-radius: 10px; transition: var(--transition);
            border: 2px solid var(--primary);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }
        .institute-name {
            color: var(--primary); font-size: 28px; font-weight: bold;
            margin-top: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .institute-subtitle {
            color: var(--secondary); font-size: 18px; font-weight: 600;
            margin-top: 5px; font-style: italic;
        }
        .logo-placeholder {
            width: 800px; height: 120px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            margin: 0 auto; color: white; font-size: 24px; text-align: center;
            border: 3px dashed var(--primary); font-weight: bold;
            flex-direction: column; gap: 8px;
        }
        .logo-placeholder i {
            font-size: 40px;
        }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--primary); font-size: 32px; margin-bottom: 10px; font-weight: 700; }
        .header p { color: var(--gray); font-size: 16px; }
        
        .notification {
            position: fixed; top: 20px; right: 20px; background: var(--white); padding: 20px;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); min-width: 300px;
            max-width: 400px; z-index: 9999; display: none; animation: slideInRight 0.4s ease;
        }
        @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { border-right: 5px solid var(--success); }
        .notification.error { border-right: 5px solid var(--danger); }
        .notification.info { border-right: 5px solid var(--info); }
        .notification.warning { border-right: 5px solid var(--warning); }
        .notification-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .notification-title { font-weight: bold; font-size: 16px; color: var(--dark); }
        .notification-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray); }
        .notification-body { color: var(--gray); font-size: 14px; line-height: 1.6; }
        .error-msg {
            background: rgba(220, 53, 69, 0.1); color: var(--danger); padding: 15px; border-radius: 8px;
            margin-bottom: 20px; display: none; text-align: center; border: 1px solid var(--danger); font-weight: 600;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--dark); font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-group input {
            width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 16px; transition: var(--transition); background: var(--white);
        }
        .form-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .login-btn {
            width: 100%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white); padding: 16px; border: none; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .dashboard { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white); padding: 30px; border-radius: 15px; margin-bottom: 30px;
            text-align: center; box-shadow: var(--shadow);
        }
        .dashboard-header h2 { font-size: 28px; margin-bottom: 10px; font-weight: 700; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px;
            border-radius: 15px; text-align: center; transition: var(--transition); box-shadow: var(--shadow);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 8px; }
        
        .action-section {
            background: var(--white); border-radius: 15px; padding: 25px; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05);
        }
        .action-section h3 { color: var(--dark); margin-bottom: 20px; font-size: 22px; }
        .buttons-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .action-btn, .details-btn, .export-btn, .print-btn {
            padding: 14px 24px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center;
            gap: 8px; flex: 1; min-width: 140px; justify-content: center; color: var(--white);
        }
        .action-btn { background: var(--primary); }
        .action-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .details-btn { background: var(--info); }
        .details-btn:hover { background: #138496; transform: translateY(-2px); }
        .export-btn { background: var(--success); }
        .export-btn:hover { background: #218838; transform: translateY(-2px); }
        .print-btn { background: #e44d26; }
        .print-btn:hover { background: #c53c1a; transform: translateY(-2px); }
        .filter-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-select {
            padding: 10px 14px; border-radius: 8px; border: 2px solid #e0e0e0;
            font-size: 14px; transition: var(--transition); flex: 1; min-width: 120px;
        }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; }
        table th { background: var(--primary); color: var(--white); padding: 14px; text-align: center; font-weight: 600; }
        table td { padding: 14px; text-align: center; border-bottom: 1px solid #eee; }
        table tr:hover { background: #f9f9f9; }
        .logout-btn {
            background: var(--danger); color: var(--white); padding: 14px 30px; border: none;
            border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px;
            width: 100%; transition: var(--transition);
        }
        .logout-btn:hover { background: #c82333; transform: translateY(-2px); }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; padding: 20px;
        }
        .modal-content {
            background: var(--white); padding: 30px; border-radius: 15px; width: 100%;
            max-width: 1200px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 50px rgba(0,0,0,0.2);
        }
        .close-btn {
            background: var(--danger); color: var(--white); padding: 8px 16px; border: none;
            border-radius: 8px; cursor: pointer; float: left; font-size: 18px; font-weight: bold;
        }
        .attendance-details-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .detail-stat-card { text-align: center; padding: 20px; border-radius: 12px; border: 2px solid; }
        .detail-stat-present { background: rgba(40, 167, 69, 0.1); border-color: var(--success); }
        .detail-stat-absent { background: rgba(220, 53, 69, 0.1); border-color: var(--danger); }
        .detail-stat-total { background: rgba(23, 162, 184, 0.1); border-color: var(--info); }
        .detail-stat-number { font-size: 36px; font-weight: bold; margin-bottom: 5px; }
        .detail-stat-present .detail-stat-number { color: var(--success); }
        .detail-stat-absent .detail-stat-number { color: var(--danger); }
        .detail-stat-total .detail-stat-number { color: var(--info); }
        .student-list h4 { color: var(--dark); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .student-item {
            display: flex; justify-content: space-between; align-items: center; padding: 15px;
            margin-bottom: 10px; border-radius: 10px; background: #f8f9fa; transition: var(--transition);
        }
        .student-item:hover { background: #e9ecef; transform: translateX(-5px); }
        .student-name { font-weight: bold; color: var(--dark); font-size: 16px; margin-bottom: 5px; }
        .student-details { font-size: 13px; color: var(--gray); }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .status-present { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .status-absent { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .teacher-section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef; }
        .teacher-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 2px solid #dee2e6;
        }
        .teacher-name { font-size: 20px; font-weight: bold; color: var(--primary); }
        .class-record { background: var(--white); padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e9ecef; }
        .absent-count {
            background: rgba(220, 53, 69, 0.15); color: var(--danger); padding: 6px 12px;
            border-radius: 20px; font-weight: bold; font-size: 14px;
        }
        .no-print { display: table-cell; }
        
        /* Ø²ÛŒØ§Ø¯Ú©Ø±Ø§ÙˆÛ• Ø¨Û† Ø´ÛŒÚ©Ø§Ø±ÛŒ Ú©Ø§Øª */
        .time-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .time-slot-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        .time-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .time-slot-title {
            font-weight: bold;
            color: var(--dark);
        }
        .time-slot-count {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .time-slot-students {
            max-height: 200px;
            overflow-y: auto;
        }
        .time-student-item {
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .time-student-name {
            font-size: 14px;
        }
        .time-student-group {
            font-size: 12px;
            color: var(--gray);
        }

        @media print {
            body * { visibility: hidden; }
            .modal-content, .modal-content * { visibility: visible; }
            .modal-content { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; }
            .no-print { display: none !important; }
        }
        
        /* ÙˆÛ•ÚµØ§Ù…Ø¯Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¦Û•ÙˆÛ•Ù†Ø¯Û• Ø¨Ú†ÙˆÙˆÚ©Û•Ú©Ø§Ù† */
        @media (max-width: 900px) {
            .institute-logo, .logo-placeholder {
                width: 100%; max-width: 600px; height: 90px;
            }
            .logo-container {
                padding: 12px;
            }
            .institute-name {
                font-size: 24px;
            }
            .institute-subtitle {
                font-size: 16px;
            }
            .logo-placeholder {
                font-size: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            .institute-logo, .logo-placeholder {
                width: 100%; max-width: 500px; height: 70px;
            }
            .logo-container {
                padding: 10px;
            }
            .institute-name {
                font-size: 22px;
            }
            .institute-subtitle {
                font-size: 15px;
            }
            .logo-placeholder {
                font-size: 18px;
            }
            .header h1 { font-size: 24px; }
            .stats-grid { grid-template-columns: 1fr; }
            .buttons-row { flex-direction: column; }
            .action-btn, .details-btn, .export-btn, .print-btn { width: 100%; min-width: auto; }
            .attendance-details-stats { grid-template-columns: 1fr; }
            .filter-container { flex-direction: column; }
            .filter-select { width: 100%; }
            .modal-content { padding: 20px 15px; }
            table { font-size: 14px; }
            table th, table td { padding: 10px 8px; }
            .time-breakdown { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .institute-logo, .logo-placeholder {
                width: 100%; max-width: 350px; height: 60px;
            }
            .institute-name {
                font-size: 20px;
            }
            .institute-subtitle {
                font-size: 14px;
            }
            .logo-placeholder {
                font-size: 16px;
                flex-direction: column;
                gap: 5px;
            }
            .logo-placeholder i {
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification">
        <div class="notification-header">
            <span class="notification-title" id="notificationTitle">Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•</span>
            <button class="notification-close" onclick="closeNotification()">&times;</button>
        </div>
        <div class="notification-body" id="notificationBody"></div>
    </div>

    <div id="loginPage" class="container">
        <div class="header">
            <!-- Ù„Û†Ú¯Û† Ù„Û•Ø³Û•Ø± Ø´Ø§Ø´Û•ÛŒ Ù„Û†Ú¯ÛŒÙ† -->
          <div class="logo-container">
    <div id="loginLogoContainer">
        <!-- Ù„Û†Ú¯Û†ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ Ù„Û• GitHub -->
        <img src="https://raw.githubusercontent.com/cis-web/CIS-SUL-APP/main/cis-web/logo.png" 
             alt="Ù„Û†Ú¯Û†ÛŒ Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ" 
             class="institute-logo" 
             id="loginLogo"
             onerror="this.style.display='none'; document.getElementById('loginLogoPlaceholder').style.display='flex';">
        
        <!-- Ù„Û†Ú¯Û†ÛŒ CSS (Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª) -->
        <div id="loginLogoPlaceholder" class="logo-placeholder" style="display: none;">
            <i class="fas fa-graduation-cap"></i>
            <span>Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</span>
        </div>
    </div>
    <div class="institute-name">Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</div>
    <div class="institute-subtitle">Slemani Computer Institute</div>
</div>
            <h1>ğŸ“ Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯ÛŒ ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª</h1>
            <p>ØªÚ©Ø§ÛŒÛ• Ø¨Ú•Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Û† Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</p>
        </div>
        <div class="error-msg" id="errorMsg">Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± ÛŒØ§Ù† ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•!</div>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label>ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="login-btn">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
        </form>
    </div>

    <div id="staffDashboard" class="container dashboard">
        <!-- Ù„Û†Ú¯Û† Ù„Û•Ø³Û•Ø± Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯ -->
        <div class="logo-container">
            <div id="dashboardLogoContainer">
                <img src="https://sanishtech.com/i/690c4fb91619a-1762414521.png" alt="Ù„Û†Ú¯Û†ÛŒ Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ" class="institute-logo" id="dashboardLogo">
            </div>
            <div class="institute-name">Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</div>
            <div class="institute-subtitle">Slemani Computer Institute</div>
        </div>
        
        <div class="dashboard-header">
            <h2>ğŸ“Š Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯ÛŒ Ú©Ø§Ø±Ù…Û•Ù†Ø¯ÛŒ ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª</h2>
            <p id="staffWelcome">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="totalRecords">0</div><div>Ú©Û†ÛŒ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†</div></div>
            <div class="stat-card"><div class="stat-number" id="totalPresent">0</div><div>Ø¦Ø§Ù…Ø§Ø¯Û•</div></div>
            <div class="stat-card"><div class="stat-number" id="totalAbsent">0</div><div>ØºÛŒØ§Ø¨</div></div>
        </div>
        
        <div class="action-section">
            <h3>Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</h3>
            <div class="buttons-row">
                <button class="action-btn" onclick="viewTodayAttendance()">ğŸ“… ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û†</button>
                <button class="action-btn" onclick="viewTeachersAttendance()" style="background: var(--info);">ğŸ‘¨â€ğŸ« Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†</button>
                <button class="action-btn" onclick="viewTimeAnalysis()" style="background: var(--warning); color: var(--dark);">â° Ø´ÛŒÚ©Ø§Ø±ÛŒ Ú©Ø§ØªÛŒ ØºÛŒØ§Ø¨Ø§Øª</button>
            </div>
            <div class="buttons-row">
                <button class="details-btn" onclick="viewTotalStudentAbsence()">ğŸ“Š Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ ØºÛŒØ§Ø¨Ø§Øª</button>
                <button class="export-btn" onclick="viewDetailedAbsence()" style="background: var(--secondary);">ğŸ“‹ ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛ•Ú©Ø§Ù†</button>
            </div>
            <div class="buttons-row">
                <button class="details-btn" onclick="refreshData()" style="background: var(--warning); color: var(--dark);">ğŸ”„ Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>
            </div>
            
            <div class="filter-container">
                <input type="date" id="filterDate" class="filter-select" onchange="loadAttendanceData()">
                <select id="filterLevel" onchange="loadAttendanceData()" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§Ø³ØªÛ•Ú©Ø§Ù†</option>
                    <option value="1">Ø¦Ø§Ø³ØªÛŒ 1</option>
                    <option value="2">Ø¦Ø§Ø³ØªÛŒ 2</option>
                    <option value="3">Ø¦Ø§Ø³ØªÛŒ 3</option>
                    <option value="4">Ø¦Ø§Ø³ØªÛŒ 4</option>
                    <option value="5">Ø¦Ø§Ø³ØªÛŒ 5</option>
                </select>
                <select id="filterGroup" onchange="loadAttendanceData()" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ú¯Ø±ÙˆÙˆÙ¾Û•Ú©Ø§Ù†</option>
                    <option value="A">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ A</option>
                    <option value="B">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ B</option>
                    <option value="C">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ C</option>
                    <option value="D">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ D</option>
                    <option value="E">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ E</option>
                    <option value="WEB">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ WEB</option>
                    <option value="NET">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ NET</option>
                    <option value="PRO">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ PRO</option>
                </select>
            </div>
            
            <div class="buttons-row">
                <button class="export-btn" onclick="exportTodayToExcel()">ğŸ“¥ Ù‡Û•Ù†Ø§Ø±Ø¯Û• Ø¨Û† Excel</button>
                <button class="print-btn" onclick="printTodayAttendance()">ğŸ–¨ï¸ Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†</button>
            </div>
            
            <div class="table-container">
                <table id="todayAttendanceTable">
                    <thead>
                        <tr>
                            <th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>Ù…Ø§Ù…Û†Ø³ØªØ§</th><th>ÙˆØ§Ù†Û•</th><th>Ø¦Ø§Ø³Øª</th><th>Ú¯Ø±ÙˆÙˆÙ¾</th>
                            <th>Ú©Ø§Øª</th><th>Ø¦Ø§Ù…Ø§Ø¯Û•</th><th>ØºÛŒØ§Ø¨</th><th class="no-print">Ú©Ø±Ø¯Ø§Ø±Û•Ú©Ø§Ù†</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <tr><td colspan="9" style="padding: 40px;">ØªÚ©Ø§ÛŒÛ• ÙÙ„ØªÛ•Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <button class="logout-btn" onclick="logout()">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px;">
            <div style="color: var(--dark); font-size: 16px; font-weight: 600; margin-bottom: 8px;">ğŸ‘¨â€ğŸ’» Ø¯Ø±ÙˆØ³ØªÚ©Û•Ø±</div>
            <div style="color: var(--primary); font-size: 18px; font-weight: bold; margin-bottom: 8px;">Ù…Ø§Ø¬Ø¯ Ø§Ù†ÙˆØ±</div>
            <div style="color: var(--gray); font-size: 14px;">
                <i class="fas fa-phone"></i>
                <a href="tel:07701458474" style="color: var(--info); text-decoration: none; font-weight: 600;">Ù Ù§Ù§Ù Ù¡Ù¤Ù¥Ù¨Ù¤Ù§Ù¤</a>
            </div>
        </div>
    </div>

    <!-- Ù…Û†Ø¯Ø§Ù„Û•Ú©Ø§Ù† -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeDetailsModal()">&times;</button>
            <h2 style="clear: both; margin-bottom: 20px;" id="detailsTitle">ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ†</h2>
            <div class="attendance-details-stats">
                <div class="detail-stat-card detail-stat-present"><div class="detail-stat-number" id="detailPresent">0</div><div>Ø¦Ø§Ù…Ø§Ø¯Û•</div></div>
                <div class="detail-stat-card detail-stat-absent"><div class="detail-stat-number" id="detailAbsent">0</div><div>ØºÛŒØ§Ø¨</div></div>
                <div class="detail-stat-card detail-stat-total"><div class="detail-stat-number" id="detailTotal">0</div><div>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ</div></div>
            </div>
            <div id="studentListContainer"></div>
        </div>
    </div>

    <div id="totalAbsenceModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAbsenceModal()">&times;</button>
            <h2 style="clear: both; margin-bottom: 20px;">Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†</h2>
            <div class="filter-container">
                <input type="date" id="startDate" class="filter-select">
                <input type="date" id="endDate" class="filter-select">
                <button class="action-btn" onclick="loadAbsenceData()">ğŸ” Ú¯Û•Ú•Ø§Ù†</button>
                <button class="export-btn" onclick="exportAbsence()">ğŸ“¥ Excel</button>
                <button class="print-btn" onclick="printAbsenceData()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
            </div>
            <div class="table-container">
                <table id="totalAbsenceTable">
                    <thead><tr><th>Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</th><th>Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•</th><th>Ø¦Ø§Ø³Øª</th><th>Ú¯Ø±ÙˆÙ¾</th><th>Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</th></tr></thead>
                    <tbody id="absenceTableBody"><tr><td colspan="5" style="padding: 40px;">ØªÚ©Ø§ÛŒÛ• Ø¨Û•Ø±ÙˆØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="detailedAbsenceModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeDetailedAbsenceModal()">&times;</button>
            <h2 style="clear: both; margin-bottom: 20px;">ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛ•Ú©Ø§Ù†</h2>
            <div class="filter-container">
                <input type="date" id="detailedStartDate" class="filter-select">
                <input type="date" id="detailedEndDate" class="filter-select">
                <select id="detailedLevel" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§Ø³ØªÛ•Ú©Ø§Ù†</option>
                    <option value="1">Ø¦Ø§Ø³ØªÛŒ 1</option>
                    <option value="2">Ø¦Ø§Ø³ØªÛŒ 2</option>
                    <option value="3">Ø¦Ø§Ø³ØªÛŒ 3</option>
                    <option value="4">Ø¦Ø§Ø³ØªÛŒ 4</option>
                    <option value="5">Ø¦Ø§Ø³ØªÛŒ 5</option>
                </select>
                <select id="detailedGroup" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ú¯Ø±ÙˆÙˆÙ¾Û•Ú©Ø§Ù†</option>
                    <option value="A">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ A</option>
                    <option value="B">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ B</option>
                    <option value="C">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ C</option>
                    <option value="D">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ D</option>
                    <option value="E">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ E</option>
                    <option value="WEB">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ WEB</option>
                    <option value="NET">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ NET</option>
                    <option value="PRO">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ PRO</option>
                </select>
                <button class="action-btn" onclick="loadDetailedAbsence()">ğŸ” Ú¯Û•Ú•Ø§Ù†</button>
                <button class="export-btn" onclick="exportDetailedAbsence()">ğŸ“¥ Excel</button>
                <button class="print-btn" onclick="printDetailedAbsence()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
            </div>
            <div class="table-container">
                <table id="detailedAbsenceTable">
                    <thead>
                        <tr>
                            <th>Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</th><th>Ú©Û†Ø¯</th><th>Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•</th><th>Ø¦Ø§Ø³Øª</th><th>Ú¯Ø±ÙˆÙ¾</th>
                            <th>Ø¨Û•Ø±ÙˆØ§Ø±</th><th>ÙˆØ§Ù†Û•</th><th>Ù…Ø§Ù…Û†Ø³ØªØ§</th><th>Ú©Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="detailedAbsenceTableBody">
                        <tr><td colspan="9" style="padding: 40px;">ØªÚ©Ø§ÛŒÛ• ÙÙ„ØªÛ•Ø±Û•Ú©Ø§Ù† Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="teachersModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeTeachersModal()">&times;</button>
            <h2 style="clear: both; margin-bottom: 20px;">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†</h2>
            <div class="attendance-details-stats">
                <div class="detail-stat-card detail-stat-total"><div class="detail-stat-number" id="totalTeachers">0</div><div>Ú©Û†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§Ú©Ø§Ù†</div></div>
                <div class="detail-stat-card detail-stat-present"><div class="detail-stat-number" id="totalRecordsToday">0</div><div>Ú©Û†ÛŒ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†</div></div>
                <div class="detail-stat-card detail-stat-absent"><div class="detail-stat-number" id="totalAbsencesToday">0</div><div>Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</div></div>
            </div>
            <div class="buttons-row" style="margin-bottom: 20px;">
                <button class="print-btn" onclick="printTeachersToday()">ğŸ–¨ï¸ Ú†Ø§Ù¾ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†</button>
            </div>
            <div id="teachersListContainer"></div>
        </div>
    </div>

    <div id="timeAnalysisModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeTimeAnalysisModal()">&times;</button>
            <h2 style="clear: both; margin-bottom: 20px;">Ø´ÛŒÚ©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª Ø¨Û•Ù¾ÛÛŒ Ú©Ø§Øª</h2>
            
            <div class="filter-container">
                <input type="date" id="timeAnalysisDate" class="filter-select" value="">
                <select id="timeAnalysisLevel" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§Ø³ØªÛ•Ú©Ø§Ù†</option>
                    <option value="1">Ø¦Ø§Ø³ØªÛŒ 1</option>
                    <option value="2">Ø¦Ø§Ø³ØªÛŒ 2</option>
                    <option value="3">Ø¦Ø§Ø³ØªÛŒ 3</option>
                    <option value="4">Ø¦Ø§Ø³ØªÛŒ 4</option>
                    <option value="5">Ø¦Ø§Ø³ØªÛŒ 5</option>
                </select>
                <select id="timeAnalysisGroup" class="filter-select">
                    <option value="">Ù‡Û•Ù…ÙˆÙˆ Ú¯Ø±ÙˆÙˆÙ¾Û•Ú©Ø§Ù†</option>
                    <option value="A">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ A</option>
                    <option value="B">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ B</option>
                    <option value="C">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ C</option>
                    <option value="D">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ D</option>
                    <option value="E">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ E</option>
                    <option value="WEB">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ WEB</option>
                    <option value="NET">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ NET</option>
                    <option value="PRO">Ú¯Ø±ÙˆÙˆÙ¾ÛŒ PRO</option>
                </select>
                <button class="action-btn" onclick="loadTimeAnalysisData()">ğŸ” Ú¯Û•Ú•Ø§Ù†</button>
                <button class="export-btn" onclick="exportTimeAnalysis()">ğŸ“¥ Excel</button>
                <button class="print-btn" onclick="printTimeAnalysis()">ğŸ–¨ï¸ Ú†Ø§Ù¾</button>
            </div>
            
            <div class="attendance-details-stats">
                <div class="detail-stat-card detail-stat-total"><div class="detail-stat-number" id="totalTimeAbsences">0</div><div>Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</div></div>
                <div class="detail-stat-card detail-stat-present"><div class="detail-stat-number" id="totalTimeSlots">0</div><div>Ú©Û†ÛŒ Ú©Ø§ØªÛ•Ú©Ø§Ù†</div></div>
                <div class="detail-stat-card detail-stat-absent"><div class="detail-stat-number" id="peakAbsenceTime">-</div><div>Ú©Ø§ØªÛŒ Ø²Û†Ø±ØªØ±ÛŒÙ† ØºÛŒØ§Ø¨</div></div>
            </div>
            
            <div id="timeBreakdownContainer" class="time-breakdown">
                <!-- Ø¯Ø§ØªØ§Ú©Ø§Ù†ÛŒ Ú©Ø§ØªÛ•Ú©Ø§Ù† Ù„ÛØ±Û• Ø¯ÛÙ† -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDummy-Key",
            authDomain: "schedules-77d76.firebaseapp.com",
            databaseURL: "https://schedules-77d76-default-rtdb.firebaseio.com",
            projectId: "schedules-77d76",
            storageBucket: "schedules-77d76.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:dummy"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser = null;
        let allStudents = [];

        // ÙÛ•Ù†Ú©Ø´Ù†ÛŒ Ú†Ø§Ù¾ÛŒ Ø¨Ø§Ø´ØªØ± Ø¨Û† Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§Ù…ÛØ±Û•Ú©Ø§Ù†
        function improvedPrint(content, title = "Ù¾Û•Ú•Û•ÛŒ Ú†Ø§Ù¾") {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Ú•ÛÚ¯Ø§ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„ - Ø¯Ø§Ú¯Ø±ØªÙ†ÛŒ ÙØ§ÛŒÙ„
                showMobilePrintHelp();
                const blob = new Blob([`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${title}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                margin: 20px; 
                                line-height: 1.6;
                                direction: rtl;
                            }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #667eea; color: white; }
                            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px; }
                            .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #667eea; }
                            .print-date { color: #666; margin-bottom: 5px; }
                            .teacher-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                            .teacher-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
                            .teacher-name { font-size: 18px; font-weight: bold; color: #667eea; }
                            .class-record { margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
                            .time-slot-card { margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; border-left: 4px solid #667eea; }
                            .time-slot-header { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #eee; }
                            @media print {
                                body { margin: 0; padding: 15px; }
                                .no-print { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `], { type: 'text/html' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } else {
                // Ú•ÛÚ¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø± - Ú†Ø§Ù¾ÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>${title}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                margin: 20px; 
                                line-height: 1.6;
                                direction: rtl;
                            }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #667eea; color: white; }
                            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 15px; }
                            .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #667eea; }
                            .print-date { color: #666; margin-bottom: 5px; }
                            .teacher-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                            .teacher-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
                            .teacher-name { font-size: 18px; font-weight: bold; color: #667eea; }
                            .class-record { margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
                            .time-slot-card { margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; border-left: 4px solid #667eea; }
                            .time-slot-header { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #eee; }
                            @media print {
                                body { margin: 0; padding: 15px; }
                                .no-print { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <script>
                            setTimeout(() => {
                                window.print();
                            }, 500);
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
        }

        function showMobilePrintHelp() {
            showNotification(
                "Ú•ÛÙ†Ù…Ø§ÛŒÛŒ Ú†Ø§Ù¾ Ø¨Û† Ù…Û†Ø¨Ø§ÛŒÙ„", 
                "ÙØ§ÛŒÙ„Û•Ú©Û• Ø¯Ø§Ú¯ÛŒØ±Ø³Ø§. ØªÚ©Ø§ÛŒÛ•: Ù¡. ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Ú©Û•Ø±Û•ÙˆÛ• Ù¢. Ù„Û• Ø¦Û•Ù¾Ù„ÛŒÚ©Û•ÛŒØ´Ù†Û•Ú©Û•Ø¯Ø§ Ú†Ø§Ù¾ÛŒ Ø¨Ú©Û• ğŸ–¨ï¸", 
                "info"
            );
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationBody = document.getElementById('notificationBody');
            notification.classList.remove('success', 'error', 'info', 'warning');
            notification.classList.add(type);
            notificationTitle.textContent = title;
            notificationBody.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => closeNotification(), 5000);
        }

        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        function parseLevelGroup(levelGroup) {
            if (levelGroup.includes('WEB')) return { currentLevel: levelGroup.replace('WEB', ''), currentGroup: 'WEB' };
            if (levelGroup.includes('NET')) return { currentLevel: levelGroup.replace('NET', ''), currentGroup: 'NET' };
            if (levelGroup.includes('PRO')) return { currentLevel: levelGroup.replace('PRO', ''), currentGroup: 'PRO' };
            return { 
                currentLevel: levelGroup.substring(0, levelGroup.length - 1), 
                currentGroup: levelGroup.substring(levelGroup.length - 1) 
            };
        }

        function loadStudents() {
            database.ref('students').on('value', (snapshot) => {
                const students = snapshot.val();
                allStudents = [];
                if (students) {
                    Object.keys(students).forEach((key) => {
                        allStudents.push({ id: key, ...students[key] });
                    });
                }
            });
        }

        // ÙÛ•Ù†Ú©Ø´Ù†ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù„Û†Ú¯Û†
        function loadInstituteLogo() {
            const logos = document.querySelectorAll('.institute-logo');
            
            logos.forEach(logo => {
                // Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ù‡Û•ÚµÛ• Ø¨Û† Ù„Û†Ú¯Û†
                logo.onerror = function() {
                    console.log("Ù„Û†Ú¯Û†Ú©Û• Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¨Ø§Ø±Ø¨Ú©Ø±ÛØª");
                    this.style.display = 'none';
                    // Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ù¾Ù„Û•ÛŒØ³ Ù‡Û†ÚµØ¯Û•Ø± Ù„Û• Ú©Ø§ØªÛŒ Ù‡Û•ÚµÛ•
                    const placeholder = document.createElement('div');
                    placeholder.className = 'logo-placeholder';
                    placeholder.innerHTML = '<i class="fas fa-graduation-cap"></i>Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ';
                    this.parentElement.appendChild(placeholder);
                };
                
                // ØªØ§Ù‚ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ ÙˆÛÙ†Û•
                const testImg = new Image();
                testImg.onload = function() {
                    console.log('Ù„Û†Ú¯Û†Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø¨Ø§Ø±Ú©Ø±Ø§');
                };
                testImg.onerror = function() {
                    console.log('Ù„Û†Ú¯Û†Ú©Û• Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¨Ø§Ø±Ø¨Ú©Ø±ÛØª');
                    logo.style.display = 'none';
                    const placeholder = document.createElement('div');
                    placeholder.className = 'logo-placeholder';
                    placeholder.innerHTML = '<i class="fas fa-graduation-cap"></i>Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Ø§ÛŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ÛŒ Ø³Ù„ÛÙ…Ø§Ù†ÛŒ';
                    logo.parentElement.appendChild(placeholder);
                };
                testImg.src = logo.src;
            });
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (username === 'attendance1113' && password === 'attendance1113') {
                currentUser = { username: '', type: 'staff' };
                showStaffDashboard();
                showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', 'Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú†ÙˆÙˆÛŒØªÛ• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•! ğŸ‰', 'success');
                return;
            }
            
            document.getElementById('errorMsg').style.display = 'block';
            showNotification('Ù‡Û•ÚµÛ•', 'Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± ÛŒØ§Ù† ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•!', 'error');
            setTimeout(() => {
                document.getElementById('errorMsg').style.display = 'none';
            }, 3000);
        }

        function showStaffDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('staffDashboard').style.display = 'block';
            document.getElementById('staffWelcome').textContent = 'Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª ' + (currentUser?.username || 'Ú©Ø§Ø±Ù…Û•Ù†Ø¯');
            loadStudents();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            loadAttendanceData();
        }

        function loadAttendanceData() {
            const date = document.getElementById('filterDate').value;
            const level = document.getElementById('filterLevel').value;
            const group = document.getElementById('filterGroup').value;
            
            if (!date) {
                showNotification('Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•', 'ØªÚ©Ø§ÛŒÛ• Ø¨Û•Ø±ÙˆØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!', 'warning');
                return;
            }
            
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '<tr><td colspan="9">Ú©Û•Ù…ÛÚ© Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•...</td></tr>';
            
            database.ref('attendance/' + date).once('value', (snapshot) => {
                const data = snapshot.val();
                const records = [];
                
                const uniquePresentStudents = new Set();
                const uniqueAbsentStudents = new Set();
                
                if (data) {
                    Object.keys(data).forEach(levelGroup => {
                        const { currentLevel, currentGroup } = parseLevelGroup(levelGroup);
                        
                        if (level && currentLevel !== level) return;
                        if (group && currentGroup !== group) return;
                        
                        const levelGroupData = data[levelGroup];
                        
                        Object.keys(levelGroupData).forEach(subject => {
                            const subjectData = levelGroupData[subject];
                            
                            Object.keys(subjectData).forEach(time => {
                                const timeData = subjectData[time];
                                
                                Object.keys(timeData).forEach(teacher => {
                                    const attendance = timeData[teacher];
                                    let present = 0, absent = 0;
                                    
                                    Object.keys(attendance).forEach(studentId => {
                                        const status = attendance[studentId];
                                        if (status === 'present') {
                                            present++;
                                            uniquePresentStudents.add(studentId);
                                        }
                                        if (status === 'absent') {
                                            absent++;
                                            uniqueAbsentStudents.add(studentId);
                                        }
                                    });
                                    
                                    records.push({
                                        date, teacher, subject,
                                        level: currentLevel,
                                        group: currentGroup,
                                        time, present, absent,
                                        attendanceData: attendance
                                    });
                                });
                            });
                        });
                    });
                }
                
                displayAttendanceData(records);
                document.getElementById('totalRecords').textContent = records.length;
                document.getElementById('totalPresent').textContent = uniquePresentStudents.size;
                document.getElementById('totalAbsent').textContent = uniqueAbsentStudents.size;
                
                if (records.length > 0) {
                    showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', `${records.length} ØªÛ†Ù…Ø§Ø± Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•`, 'success');
                } else {
                    showNotification('Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•', 'Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•', 'info');
                }
            }).catch(error => {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡Û•ÚµÛ• Ù„Û• Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†', 'error');
                console.error(error);
            });
        }

        function displayAttendanceData(data) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px;">Ù‡ÛŒÚ† ØªÛ†Ù…Ø§Ø±ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•</td></tr>';
                return;
            }
            
            data.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.teacher}</td>
                    <td>${record.subject}</td>
                    <td>Ø¦Ø§Ø³ØªÛŒ ${record.level}</td>
                    <td>Ú¯Ø±ÙˆÙ¾ÛŒ ${record.group}</td>
                    <td>${record.time}</td>
                    <td><span style="color: var(--success); font-weight: bold;">${record.present}</span></td>
                    <td><span style="color: var(--danger); font-weight: bold;">${record.absent}</span></td>
                    <td class="no-print">
                        <button class="details-btn" style="padding: 8px 14px; font-size: 13px;" 
                                onclick='viewDetails(${JSON.stringify(record).replace(/'/g, "&#39;")})'>
                            ğŸ‘ï¸ Ø¨ÛŒÙ†ÛŒÙ†
                        </button>
                    </td>
                `;
            });
        }

        function viewDetails(record) {
            const modal = document.getElementById('detailsModal');
            const title = document.getElementById('detailsTitle');
            const presentCount = document.getElementById('detailPresent');
            const absentCount = document.getElementById('detailAbsent');
            const totalCount = document.getElementById('detailTotal');
            const studentListContainer = document.getElementById('studentListContainer');
            
            title.textContent = `ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û•Ø¨ÙˆÙˆÙ† - ${record.subject} - Ø¦Ø§Ø³ØªÛŒ ${record.level} Ú¯Ø±ÙˆÙ¾ÛŒ ${record.group}`;
            
            const groupStudents = allStudents.filter(s => 
                s.level === record.level && s.group === record.group
            );
            
            let presentStudents = [];
            let absentStudents = [];
            
            groupStudents.forEach(student => {
                const status = record.attendanceData[student.id] || 'present';
                if (status === 'present') {
                    presentStudents.push(student);
                } else {
                    absentStudents.push(student);
                }
            });
            
            presentCount.textContent = presentStudents.length;
            absentCount.textContent = absentStudents.length;
            totalCount.textContent = groupStudents.length;
            
            studentListContainer.innerHTML = '';
            
            if (presentStudents.length > 0) {
                const presentSection = document.createElement('div');
                presentSection.className = 'student-list';
                presentSection.innerHTML = `<h4>âœ… Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†ÛŒ Ø¦Ø§Ù…Ø§Ø¯Û• (${presentStudents.length})</h4>`;
                
                presentStudents.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-details">Ú©Û†Ø¯: ${student.code} | ${student.institute}</div>
                        </div>
                        <span class="status-badge status-present">âœ“ Ø¦Ø§Ù…Ø§Ø¯Û•</span>
                    `;
                    presentSection.appendChild(item);
                });
                
                studentListContainer.appendChild(presentSection);
            }
            
            if (absentStudents.length > 0) {
                const absentSection = document.createElement('div');
                absentSection.className = 'student-list';
                absentSection.innerHTML = `<h4>âŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†ÛŒ ØºÛŒØ§Ø¨ (${absentStudents.length})</h4>`;
                
                absentStudents.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-details">Ú©Û†Ø¯: ${student.code} | ${student.institute}</div>
                        </div>
                        <span class="status-badge status-absent">âœ— ØºÛŒØ§Ø¨</span>
                    `;
                    absentSection.appendChild(item);
                });
                
                studentListContainer.appendChild(absentSection);
            }
            
            modal.style.display = 'flex';
            
            if (absentStudents.length > 0) {
                const absentNames = absentStudents.slice(0, 3).map(s => s.name).join('ØŒ ');
                const moreText = absentStudents.length > 3 ? ` Ùˆ ${absentStudents.length - 3} Ú©Û•Ø³ÛŒ ØªØ±` : '';
                showNotification(
                    'Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†ÛŒ ØºÛŒØ§Ø¨', 
                    `${absentStudents.length} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± ØºÛŒØ§Ø¨Ù†: ${absentNames}${moreText}`, 
                    'warning'
                );
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function viewTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            document.getElementById('filterLevel').value = '';
            document.getElementById('filterGroup').value = '';
            loadAttendanceData();
            showNotification('Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•', 'ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û† Ù¾ÛŒØ´Ø§Ù†Ø¯Ø±Ø§', 'info');
        }

        function viewTeachersAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.getElementById('teachersModal');
            const teachersListContainer = document.getElementById('teachersListContainer');
            
            teachersListContainer.innerHTML = '<p style="text-align: center; padding: 40px;">Ú©Û•Ù…ÛÚ© Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•...</p>';
            modal.style.display = 'flex';
            
            database.ref('attendance/' + today).once('value', (snapshot) => {
                const data = snapshot.val();
                const teachersMap = {};
                let totalRecords = 0;
                let totalUniqueAbsences = 0;
                const uniqueAbsentStudents = new Set();
                
                if (data) {
                    Object.keys(data).forEach(levelGroup => {
                        const { currentLevel, currentGroup } = parseLevelGroup(levelGroup);
                        
                        Object.keys(data[levelGroup]).forEach(subject => {
                            const subjectData = data[levelGroup][subject];
                            
                            Object.keys(subjectData).forEach(time => {
                                const timeData = subjectData[time];
                                
                                Object.keys(timeData).forEach(teacher => {
                                    const attendance = timeData[teacher];
                                    
                                    if (!teachersMap[teacher]) {
                                        teachersMap[teacher] = {
                                            records: [],
                                            totalAbsent: 0,
                                            uniqueAbsentStudents: new Set()
                                        };
                                    }
                                    
                                    let absentCount = 0;
                                    Object.keys(attendance).forEach(studentId => {
                                        if (attendance[studentId] === 'absent') {
                                            absentCount++;
                                            teachersMap[teacher].uniqueAbsentStudents.add(studentId);
                                            uniqueAbsentStudents.add(studentId);
                                        }
                                    });
                                    
                                    teachersMap[teacher].records.push({
                                        date: today,
                                        level: currentLevel,
                                        group: currentGroup,
                                        subject: subject,
                                        time: time,
                                        absentCount: absentCount
                                    });
                                    
                                    teachersMap[teacher].totalAbsent = teachersMap[teacher].uniqueAbsentStudents.size;
                                    totalRecords++;
                                });
                            });
                        });
                    });
                    
                    totalUniqueAbsences = uniqueAbsentStudents.size;
                }
                
                displayTeachersData(teachersMap, totalRecords, totalUniqueAbsences);
            }).catch(error => {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡Û•ÚµÛ• Ù„Û• Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†', 'error');
                console.error(error);
            });
        }

        function displayTeachersData(teachersMap, totalRecords, totalAbsences) {
            const teachersListContainer = document.getElementById('teachersListContainer');
            const totalTeachers = document.getElementById('totalTeachers');
            const totalRecordsToday = document.getElementById('totalRecordsToday');
            const totalAbsencesToday = document.getElementById('totalAbsencesToday');
            
            totalTeachers.textContent = Object.keys(teachersMap).length;
            totalRecordsToday.textContent = totalRecords;
            totalAbsencesToday.textContent = totalAbsences;
            
            teachersListContainer.innerHTML = '';
            
            if (Object.keys(teachersMap).length === 0) {
                teachersListContainer.innerHTML = '<p style="text-align: center; padding: 40px;">Ù‡ÛŒÚ† Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒÛ•Ú© ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛŒÙ†ÛŒ Ù†Û•Ù†Ø§Ø±Ø¯ÙˆÛ• Ø¦Û•Ù…Ú•Û†</p>';
                return;
            }
            
            Object.keys(teachersMap).forEach(teacher => {
                const teacherData = teachersMap[teacher];
                const teacherSection = document.createElement('div');
                teacherSection.className = 'teacher-section';
                
                teacherSection.innerHTML = `
                    <div class="teacher-header">
                        <div class="teacher-name">ğŸ‘¨â€ğŸ« ${teacher}</div>
                        <div class="teacher-stats">
                            ${teacherData.records.length} ØªÛ†Ù…Ø§Ø± | Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª: ${teacherData.totalAbsent}
                        </div>
                    </div>
                `;
                
                teacherData.records.forEach(record => {
                    const classRecord = document.createElement('div');
                    classRecord.className = 'class-record';
                    classRecord.innerHTML = `
                        <div class="class-info">
                            <div style="font-weight: bold; color: var(--dark);">${record.subject}</div>
                            <span class="absent-count">${record.absentCount} ØºÛŒØ§Ø¨</span>
                        </div>
                        <div class="class-details">
                            Ø¦Ø§Ø³ØªÛŒ ${record.level} - Ú¯Ø±ÙˆÙ¾ÛŒ ${record.group} | Ú©Ø§Øª: ${record.time} | Ø¨Û•Ø±ÙˆØ§Ø±: ${record.date}
                        </div>
                    `;
                    teacherSection.appendChild(classRecord);
                });
                
                teachersListContainer.appendChild(teacherSection);
            });
            
            showNotification(
                'Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†', 
                `${Object.keys(teachersMap).length} Ù…Ø§Ù…Û†Ø³ØªØ§ ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛŒÙ†ÛŒ Ù†Ø§Ø±Ø¯ÙˆÛ• Ø¦Û•Ù…Ú•Û†`, 
                'info'
            );
        }

        function closeTeachersModal() {
            document.getElementById('teachersModal').style.display = 'none';
        }

        function printTeachersToday() {
            const teachersListContainer = document.getElementById('teachersListContainer');
            const teacherSections = teachersListContainer.getElementsByClassName('teacher-section');
            
            if (teacherSections.length === 0) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const totalTeachers = document.getElementById('totalTeachers').textContent;
            const totalRecordsToday = document.getElementById('totalRecordsToday').textContent;
            const totalAbsencesToday = document.getElementById('totalAbsencesToday').textContent;
            
            let printContent = `
                <div class="print-header">
                    <div class="print-title">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†</div>
                    <div class="print-date">Ú©Ø§ØªÛŒ Ú†Ø§Ù¾: ${new Date().toLocaleString('en-GB')}</div>
                </div>
                
                <div class="time-analysis-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #17a2b8;">${totalTeachers}</div>
                        <div>Ú©Û†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§Ú©Ø§Ù†</div>
                    </div>
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #28a745;">${totalRecordsToday}</div>
                        <div>Ú©Û†ÛŒ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†</div>
                    </div>
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #dc3545;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #dc3545;">${totalAbsencesToday}</div>
                        <div>Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</div>
                    </div>
                </div>
            `;
            
            for (let section of teacherSections) {
                const teacherName = section.querySelector('.teacher-name').textContent;
                const teacherStats = section.querySelector('.teacher-stats').textContent;
                
                printContent += `
                    <div class="teacher-section-print" style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        <div class="teacher-header-print" style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                            <div class="teacher-name-print" style="font-size: 18px; font-weight: bold;">${teacherName}</div>
                            <div class="teacher-stats-print">${teacherStats}</div>
                        </div>
                `;
                
                const classRecords = section.querySelectorAll('.class-record');
                classRecords.forEach(record => {
                    const classInfo = record.querySelector('.class-info').innerHTML;
                    const classDetails = record.querySelector('.class-details').textContent;
                    
                    printContent += `
                        <div class="class-record-print" style="margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${classInfo}
                            <div class="class-details-print" style="font-size: 13px; color: #6c757d;">${classDetails}</div>
                        </div>
                    `;
                });
                
                printContent += `</div>`;
            }
            
            improvedPrint(printContent, "Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†ÛŒ Ø¦Û•Ù…Ú•Û†");
        }

        function viewTotalStudentAbsence() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('totalAbsenceModal').style.display = 'flex';
        }

        function closeAbsenceModal() {
            document.getElementById('totalAbsenceModal').style.display = 'none';
        }

        function loadAbsenceData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Ù‡Û•ÚµÛ•', 'ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ø±Ø¯ÙˆÙˆ Ø¨Û•Ø±ÙˆØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!', 'error');
                return;
            }
            
            const tbody = document.getElementById('absenceTableBody');
            tbody.innerHTML = '<tr><td colspan="5">Ú©Û•Ù…ÛÚ© Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•...</td></tr>';
            
            database.ref('attendance').once('value', (snapshot) => {
                const data = snapshot.val();
                const studentAbsenceMap = {};
                
                if (data) {
                    Object.keys(data).forEach(dateKey => {
                        if (dateKey >= startDate && dateKey <= endDate) {
                            const dateData = data[dateKey];
                            
                            Object.keys(dateData).forEach(levelGroup => {
                                const levelGroupData = dateData[levelGroup];
                                
                                Object.keys(levelGroupData).forEach(subject => {
                                    const subjectData = levelGroupData[subject];
                                    
                                    Object.keys(subjectData).forEach(time => {
                                        const timeData = subjectData[time];
                                        
                                        Object.keys(timeData).forEach(teacher => {
                                            const attendance = timeData[teacher];
                                            
                                            Object.keys(attendance).forEach(studentId => {
                                                if (attendance[studentId] === 'absent') {
                                                    const student = allStudents.find(s => s.id === studentId);
                                                    if (student) {
                                                        if (!studentAbsenceMap[student.name]) {
                                                            studentAbsenceMap[student.name] = {
                                                                student: student,
                                                                uniqueAbsenceDays: new Set(),
                                                                totalAbsences: 0
                                                            };
                                                        }
                                                        
                                                        studentAbsenceMap[student.name].uniqueAbsenceDays.add(dateKey);
                                                        studentAbsenceMap[student.name].totalAbsences = studentAbsenceMap[student.name].uniqueAbsenceDays.size;
                                                    }
                                                }
                                            });
                                        });
                                    });
                                });
                            });
                        }
                    });
                }
                
                displayAbsenceData(studentAbsenceMap);
                
                const totalAbsent = Object.keys(studentAbsenceMap).length;
                showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', `${totalAbsent} Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø± ØºÛŒØ§Ø¨Ø§ØªÛŒØ§Ù† Ù‡Û•ÛŒÛ• Ù„Û•Ù… Ù…Û•ÙˆØ¯Ø§ÛŒÛ•Ø¯Ø§`, 'success');
            }).catch(error => {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡Û•ÚµÛ• Ù„Û• Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†', 'error');
                console.error(error);
            });
        }

        function displayAbsenceData(absenceMap) {
            const tbody = document.getElementById('absenceTableBody');
            tbody.innerHTML = '';
            
            const sortedData = Object.values(absenceMap).sort((a, b) => b.totalAbsences - a.totalAbsences);
            
            if (sortedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px;">Ù‡ÛŒÚ† ØºÛŒØ§Ø¨Ø§ØªÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•</td></tr>';
                return;
            }
            
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.student.name}</td>
                    <td>${item.student.institute}</td>
                    <td>Ø¦Ø§Ø³ØªÛŒ ${item.student.level}</td>
                    <td>Ú¯Ø±ÙˆÙ¾ÛŒ ${item.student.group}</td>
                    <td><strong style="color: #dc3545; font-size: 20px;">${item.totalAbsences}</strong></td>
                `;
            });
        }

        function exportAbsence() {
            const tbody = document.getElementById('absenceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length === 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const data = [];
            for (let row of rows) {
                if (row.cells.length > 1) {
                    data.push({
                        'Ù†Ø§Ùˆ': row.cells[0].textContent,
                        'Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•': row.cells[1].textContent,
                        'Ø¦Ø§Ø³Øª': row.cells[2].textContent,
                        'Ú¯Ø±ÙˆÙ¾': row.cells[3].textContent,
                        'Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª': row.cells[4].textContent
                    });
                }
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ØºÛŒØ§Ø¨Ø§Øª');
            XLSX.writeFile(wb, 'Ú©Û†ÛŒ_ØºÛŒØ§Ø¨Ø§ØªÛŒ_Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†.xlsx');
            
            showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', 'ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø§! ğŸ“¥', 'success');
        }

        function printAbsenceData() {
            const tbody = document.getElementById('absenceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length === 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let tableHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            tableHTML += '<thead><tr style="background: #667eea; color: white;">';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¦Ø§Ø³Øª</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú¯Ø±ÙˆÙˆÙ¾</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</th>';
            tableHTML += '</tr></thead><tbody>';
            
            for (let row of rows) {
                if (row.cells.length > 1) {
                    tableHTML += '<tr>';
                    for (let i = 0; i < row.cells.length; i++) {
                        tableHTML += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${row.cells[i].textContent}</td>`;
                    }
                    tableHTML += '</tr>';
                }
            }
            
            tableHTML += '</tbody></table>';
            
            const printContent = `
                <div class="print-header">
                    <div class="print-title">Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†</div>
                    <div class="print-date">Ù„Û• ${startDate} ØªØ§ ${endDate}</div>
                    <div class="print-date">Ú©Ø§ØªÛŒ Ú†Ø§Ù¾: ${new Date().toLocaleString('en-GB')}</div>
                </div>
                ${tableHTML}
            `;
            
            improvedPrint(printContent, "Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±Ø§Ù†");
        }

        function viewDetailedAbsence() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('detailedStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('detailedEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('detailedAbsenceModal').style.display = 'flex';
        }

        function closeDetailedAbsenceModal() {
            document.getElementById('detailedAbsenceModal').style.display = 'none';
        }

        function loadDetailedAbsence() {
            const startDate = document.getElementById('detailedStartDate').value;
            const endDate = document.getElementById('detailedEndDate').value;
            const level = document.getElementById('detailedLevel').value;
            const group = document.getElementById('detailedGroup').value;
            
            if (!startDate || !endDate) {
                showNotification('Ù‡Û•ÚµÛ•', 'ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ø±Ø¯ÙˆÙˆ Ø¨Û•Ø±ÙˆØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!', 'error');
                return;
            }
            
            const tbody = document.getElementById('detailedAbsenceTableBody');
            tbody.innerHTML = '<tr><td colspan="9">Ú©Û•Ù…ÛÚ© Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•...</td></tr>';
            
            database.ref('attendance').once('value', (snapshot) => {
                const data = snapshot.val();
                const detailedRecords = [];
                
                if (data) {
                    Object.keys(data).forEach(dateKey => {
                        if (dateKey >= startDate && dateKey <= endDate) {
                            const dateData = data[dateKey];
                            
                            Object.keys(dateData).forEach(levelGroup => {
                                const { currentLevel, currentGroup } = parseLevelGroup(levelGroup);
                                
                                if (level && currentLevel !== level) return;
                                if (group && currentGroup !== group) return;
                                
                                const levelGroupData = dateData[levelGroup];
                                
                                Object.keys(levelGroupData).forEach(subject => {
                                    const subjectData = levelGroupData[subject];
                                    
                                    Object.keys(subjectData).forEach(time => {
                                        const timeData = subjectData[time];
                                        
                                        Object.keys(timeData).forEach(teacher => {
                                            const attendance = timeData[teacher];
                                            
                                            Object.keys(attendance).forEach(studentId => {
                                                if (attendance[studentId] === 'absent') {
                                                    const student = allStudents.find(s => s.id === studentId);
                                                    if (student) {
                                                        detailedRecords.push({
                                                            studentName: student.name,
                                                            studentCode: student.code,
                                                            institute: student.institute,
                                                            level: currentLevel,
                                                            group: currentGroup,
                                                            date: dateKey,
                                                            subject: subject,
                                                            teacher: teacher,
                                                            time: time
                                                        });
                                                    }
                                                }
                                            });
                                        });
                                    });
                                });
                            });
                        }
                    });
                }
                
                displayDetailedAbsence(detailedRecords);
                showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', `${detailedRecords.length} ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•`, 'success');
            }).catch(error => {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡Û•ÚµÛ• Ù„Û• Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†', 'error');
                console.error(error);
            });
        }

        function displayDetailedAbsence(records) {
            const tbody = document.getElementById('detailedAbsenceTableBody');
            tbody.innerHTML = '';
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px;">Ù‡ÛŒÚ† ØºÛŒØ§Ø¨Ø§ØªÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•</td></tr>';
                return;
            }
            
            records.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.studentName}</td>
                    <td>${record.studentCode}</td>
                    <td>${record.institute}</td>
                    <td>Ø¦Ø§Ø³ØªÛŒ ${record.level}</td>
                    <td>Ú¯Ø±ÙˆÙ¾ÛŒ ${record.group}</td>
                    <td>${record.date}</td>
                    <td>${record.subject}</td>
                    <td>${record.teacher}</td>
                    <td>${record.time}</td>
                `;
            });
        }

        function exportDetailedAbsence() {
            const tbody = document.getElementById('detailedAbsenceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length === 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const data = [];
            for (let row of rows) {
                if (row.cells.length > 1) {
                    data.push({
                        'Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±': row.cells[0].textContent,
                        'Ú©Û†Ø¯': row.cells[1].textContent,
                        'Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•': row.cells[2].textContent,
                        'Ø¦Ø§Ø³Øª': row.cells[3].textContent,
                        'Ú¯Ø±ÙˆÙ¾': row.cells[4].textContent,
                        'Ø¨Û•Ø±ÙˆØ§Ø±': row.cells[5].textContent,
                        'ÙˆØ§Ù†Û•': row.cells[6].textContent,
                        'Ù…Ø§Ù…Û†Ø³ØªØ§': row.cells[7].textContent,
                        'Ú©Ø§Øª': row.cells[8].textContent
                    });
                }
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª');
            XLSX.writeFile(wb, 'ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ_ØºÛŒØ§Ø¨Ø§Øª.xlsx');
            
            showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', 'ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø§! ğŸ“¥', 'success');
        }

        function printDetailedAbsence() {
            const tbody = document.getElementById('detailedAbsenceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length === 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const startDate = document.getElementById('detailedStartDate').value;
            const endDate = document.getElementById('detailedEndDate').value;
            
            let tableHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            tableHTML += '<thead><tr style="background: #667eea; color: white;">';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú©Û†Ø¯</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù¾Û•ÛŒÙ…Ø§Ù†Ú¯Û•</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¦Ø§Ø³Øª</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú¯Ø±ÙˆÙ¾</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¨Û•Ø±ÙˆØ§Ø±</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">ÙˆØ§Ù†Û•</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù…Ø§Ù…Û†Ø³ØªØ§</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú©Ø§Øª</th>';
            tableHTML += '</tr></thead><tbody>';
            
            for (let row of rows) {
                if (row.cells.length > 1) {
                    tableHTML += '<tr>';
                    for (let i = 0; i < row.cells.length; i++) {
                        tableHTML += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${row.cells[i].textContent}</td>`;
                    }
                    tableHTML += '</tr>';
                }
            }
            
            tableHTML += '</tbody></table>';
            
            const printContent = `
                <div class="print-header">
                    <div class="print-title">ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛ•Ú©Ø§Ù†</div>
                    <div class="print-date">Ù„Û• ${startDate} ØªØ§ ${endDate}</div>
                    <div class="print-date">Ú©Ø§ØªÛŒ Ú†Ø§Ù¾: ${new Date().toLocaleString('en-GB')}</div>
                </div>
                ${tableHTML}
            `;
            
            improvedPrint(printContent, "ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§ØªÛ•Ú©Ø§Ù†");
        }

        function viewTimeAnalysis() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('timeAnalysisDate').value = today;
            document.getElementById('timeAnalysisModal').style.display = 'flex';
            loadTimeAnalysisData();
        }
        
        function closeTimeAnalysisModal() {
            document.getElementById('timeAnalysisModal').style.display = 'none';
        }
        
        function loadTimeAnalysisData() {
            const date = document.getElementById('timeAnalysisDate').value;
            const level = document.getElementById('timeAnalysisLevel').value;
            const group = document.getElementById('timeAnalysisGroup').value;
            
            if (!date) {
                showNotification('Ù‡Û•ÚµÛ•', 'ØªÚ©Ø§ÛŒÛ• Ø¨Û•Ø±ÙˆØ§Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!', 'error');
                return;
            }
            
            const timeBreakdownContainer = document.getElementById('timeBreakdownContainer');
            timeBreakdownContainer.innerHTML = '<p style="text-align: center; padding: 40px;">Ú©Û•Ù…ÛÚ© Ú†Ø§ÙˆÛ•Ú•Û Ø¨Ú©Û•...</p>';
            
            database.ref('attendance/' + date).once('value', (snapshot) => {
                const data = snapshot.val();
                const timeSlots = {};
                let totalAbsences = 0;
                let peakAbsenceTime = '';
                let maxAbsences = 0;
                
                if (data) {
                    Object.keys(data).forEach(levelGroup => {
                        const { currentLevel, currentGroup } = parseLevelGroup(levelGroup);
                        
                        if (level && currentLevel !== level) return;
                        if (group && currentGroup !== group) return;
                        
                        const levelGroupData = data[levelGroup];
                        
                        Object.keys(levelGroupData).forEach(subject => {
                            const subjectData = levelGroupData[subject];
                            
                            Object.keys(subjectData).forEach(time => {
                                const timeData = subjectData[time];
                                
                                Object.keys(timeData).forEach(teacher => {
                                    const attendance = timeData[teacher];
                                    
                                    if (!timeSlots[time]) {
                                        timeSlots[time] = {
                                            absentStudents: [],
                                            presentStudents: [],
                                            subject: subject,
                                            teacher: teacher,
                                            level: currentLevel,
                                            group: currentGroup
                                        };
                                    }
                                    
                                    Object.keys(attendance).forEach(studentId => {
                                        if (attendance[studentId] === 'absent') {
                                            const student = allStudents.find(s => s.id === studentId);
                                            if (student) {
                                                timeSlots[time].absentStudents.push({
                                                    name: student.name,
                                                    code: student.code,
                                                    group: student.group,
                                                    level: student.level
                                                });
                                                totalAbsences++;
                                            }
                                        }
                                    });
                                });
                            });
                        });
                    });
                    
                    // Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú©Ø§ØªÛŒ Ø²Û†Ø±ØªØ±ÛŒÙ† ØºÛŒØ§Ø¨
                    Object.keys(timeSlots).forEach(time => {
                        if (timeSlots[time].absentStudents.length > maxAbsences) {
                            maxAbsences = timeSlots[time].absentStudents.length;
                            peakAbsenceTime = time;
                        }
                    });
                }
                
                displayTimeAnalysisData(timeSlots, totalAbsences, peakAbsenceTime);
                
                if (Object.keys(timeSlots).length > 0) {
                    showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', `${totalAbsences} ØºÛŒØ§Ø¨Ø§Øª Ù„Û• ${Object.keys(timeSlots).length} Ú©Ø§ØªØ¯Ø§ Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•`, 'success');
                } else {
                    showNotification('Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•', 'info');
                }
            }).catch(error => {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡Û•ÚµÛ• Ù„Û• Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§Ú©Ø§Ù†', 'error');
                console.error(error);
            });
        }
        
        function displayTimeAnalysisData(timeSlots, totalAbsences, peakAbsenceTime) {
            const timeBreakdownContainer = document.getElementById('timeBreakdownContainer');
            const totalTimeAbsences = document.getElementById('totalTimeAbsences');
            const totalTimeSlots = document.getElementById('totalTimeSlots');
            const peakAbsenceTimeElement = document.getElementById('peakAbsenceTime');
            
            totalTimeAbsences.textContent = totalAbsences;
            totalTimeSlots.textContent = Object.keys(timeSlots).length;
            peakAbsenceTimeElement.textContent = peakAbsenceTime || '-';
            
            timeBreakdownContainer.innerHTML = '';
            
            if (Object.keys(timeSlots).length === 0) {
                timeBreakdownContainer.innerHTML = '<p style="text-align: center; padding: 40px;">Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•</p>';
                return;
            }
            
            // Ú•ÛŒØ²Ú©Ø±Ø¯Ù†ÛŒ Ú©Ø§ØªÛ•Ú©Ø§Ù† Ø¨Û•Ù¾ÛÛŒ Ú©Ø§Øª
            const sortedTimes = Object.keys(timeSlots).sort();
            
            sortedTimes.forEach(time => {
                const slot = timeSlots[time];
                const timeCard = document.createElement('div');
                timeCard.className = 'time-slot-card';
                
                let studentsHTML = '';
                if (slot.absentStudents.length > 0) {
                    slot.absentStudents.forEach(student => {
                        studentsHTML += `
                            <div class="time-student-item">
                                <div>
                                    <div class="time-student-name">${student.name}</div>
                                    <div class="time-student-group">Ú©Û†Ø¯: ${student.code} | Ø¦Ø§Ø³Øª: ${student.level} | Ú¯Ø±ÙˆÙ¾: ${student.group}</div>
                                </div>
                                <span class="status-badge status-absent">ØºÛŒØ§Ø¨</span>
                            </div>
                        `;
                    });
                } else {
                    studentsHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Ù‡ÛŒÚ† ØºÛŒØ§Ø¨ÛÚ© Ù†ÛŒÛ•</p>';
                }
                
                timeCard.innerHTML = `
                    <div class="time-slot-header">
                        <div class="time-slot-title">â° ${time}</div>
                        <div class="time-slot-count">${slot.absentStudents.length} ØºÛŒØ§Ø¨</div>
                    </div>
                    <div class="class-info" style="margin-bottom: 10px; font-size: 14px;">
                        <strong>${slot.subject}</strong> | Ù…Ø§Ù…Û†Ø³ØªØ§: ${slot.teacher}
                    </div>
                    <div class="time-slot-students">
                        ${studentsHTML}
                    </div>
                `;
                
                timeBreakdownContainer.appendChild(timeCard);
            });
        }
        
        function exportTimeAnalysis() {
            const timeBreakdownContainer = document.getElementById('timeBreakdownContainer');
            const timeCards = timeBreakdownContainer.getElementsByClassName('time-slot-card');
            
            if (timeCards.length === 0) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const data = [];
            const date = document.getElementById('timeAnalysisDate').value || 'Ù†Ø§Ø¯ÛŒØ§Ø±';
            
            for (let card of timeCards) {
                const time = card.querySelector('.time-slot-title').textContent.replace('â° ', '');
                const subjectTeacher = card.querySelector('.class-info').textContent;
                const absentCount = card.querySelector('.time-slot-count').textContent;
                
                const studentItems = card.querySelectorAll('.time-student-item');
                
                if (studentItems.length > 0) {
                    studentItems.forEach(item => {
                        const studentName = item.querySelector('.time-student-name').textContent;
                        const studentDetails = item.querySelector('.time-student-group').textContent;
                        
                        data.push({
                            'Ú©Ø§Øª': time,
                            'ÙˆØ§Ù†Û•/Ù…Ø§Ù…Û†Ø³ØªØ§': subjectTeacher,
                            'Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±': studentName,
                            'ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±': studentDetails,
                            'ØºÛŒØ§Ø¨Ø§Øª': absentCount
                        });
                    });
                } else {
                    data.push({
                        'Ú©Ø§Øª': time,
                        'ÙˆØ§Ù†Û•/Ù…Ø§Ù…Û†Ø³ØªØ§': subjectTeacher,
                        'Ù†Ø§ÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±': 'Ù‡ÛŒÚ† ØºÛŒØ§Ø¨ÛÚ© Ù†ÛŒÛ•',
                        'ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ Ø®ÙˆÛÙ†Ø¯Ú©Ø§Ø±': '',
                        'ØºÛŒØ§Ø¨Ø§Øª': absentCount
                    });
                }
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø´ÛŒÚ©Ø§Ø±ÛŒ Ú©Ø§Øª');
            XLSX.writeFile(wb, `Ø´ÛŒÚ©Ø§Ø±ÛŒ_Ú©Ø§ØªÛŒ_ØºÛŒØ§Ø¨Ø§Øª_${date}.xlsx`);
            
            showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', 'ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø§! ğŸ“¥', 'success');
        }

        function printTimeAnalysis() {
            const timeBreakdownContainer = document.getElementById('timeBreakdownContainer');
            const timeCards = timeBreakdownContainer.getElementsByClassName('time-slot-card');
            
            if (timeCards.length === 0) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const date = document.getElementById('timeAnalysisDate').value || 'Ù†Ø§Ø¯ÛŒØ§Ø±';
            const totalTimeAbsences = document.getElementById('totalTimeAbsences').textContent;
            const totalTimeSlots = document.getElementById('totalTimeSlots').textContent;
            const peakAbsenceTime = document.getElementById('peakAbsenceTime').textContent;
            
            let printContent = `
                <div class="print-header">
                    <div class="print-title">Ø´ÛŒÚ©Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª Ø¨Û•Ù¾ÛÛŒ Ú©Ø§Øª</div>
                    <div class="print-date">Ø¨Û•Ø±ÙˆØ§Ø±: ${date}</div>
                    <div class="print-date">Ú©Ø§ØªÛŒ Ú†Ø§Ù¾: ${new Date().toLocaleString('en-GB')}</div>
                </div>
                
                <div class="time-analysis-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #17a2b8;">${totalTimeAbsences}</div>
                        <div>Ú©Û†ÛŒ ØºÛŒØ§Ø¨Ø§Øª</div>
                    </div>
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #28a745;">${totalTimeSlots}</div>
                        <div>Ú©Û†ÛŒ Ú©Ø§ØªÛ•Ú©Ø§Ù†</div>
                    </div>
                    <div class="stat-card-print" style="text-align: center; padding: 15px; border-radius: 8px; border: 2px solid #dc3545;">
                        <div class="stat-number-print" style="font-size: 28px; font-weight: bold; color: #dc3545;">${peakAbsenceTime}</div>
                        <div>Ú©Ø§ØªÛŒ Ø²Û†Ø±ØªØ±ÛŒÙ† ØºÛŒØ§Ø¨</div>
                    </div>
                </div>
            `;
            
            for (let card of timeCards) {
                const time = card.querySelector('.time-slot-title').textContent.replace('â° ', '');
                const subjectTeacher = card.querySelector('.class-info').textContent;
                const absentCount = card.querySelector('.time-slot-count').textContent;
                
                let studentsHTML = '';
                const studentItems = card.querySelectorAll('.time-student-item');
                
                if (studentItems.length > 0) {
                    studentItems.forEach(item => {
                        const studentName = item.querySelector('.time-student-name').textContent;
                        const studentDetails = item.querySelector('.time-student-group').textContent;
                        
                        studentsHTML += `
                            <div class="time-student-item-print" style="padding: 6px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <div class="time-student-name-print" style="font-size: 14px;">${studentName}</div>
                                    <div class="time-student-group-print" style="font-size: 12px; color: #6c757d;">${studentDetails}</div>
                                </div>
                                <span class="status-badge-print" style="padding: 4px 10px; border-radius: 15px; background: rgba(220, 53, 69, 0.15); color: #dc3545; font-size: 12px; font-weight: bold;">ØºÛŒØ§Ø¨</span>
                            </div>
                        `;
                    });
                } else {
                    studentsHTML = '<p style="text-align: center; color: #6c757d; padding: 15px;">Ù‡ÛŒÚ† ØºÛŒØ§Ø¨ÛÚ© Ù†ÛŒÛ•</p>';
                }
                
                printContent += `
                    <div class="time-slot-card-print" style="margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div class="time-slot-header-print" style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #eee;">
                            <div class="time-slot-title-print" style="font-weight: bold;">â° ${time}</div>
                            <div class="time-slot-count-print" style="background: #667eea; color: white; padding: 3px 8px; border-radius: 15px; font-size: 13px; font-weight: bold;">${absentCount} ØºÛŒØ§Ø¨</div>
                        </div>
                        <div class="class-info-print" style="margin-bottom: 8px; font-size: 13px;">
                            ${subjectTeacher}
                        </div>
                        <div class="time-slot-students-print">
                            ${studentsHTML}
                        </div>
                    </div>
                `;
            }
            
            improvedPrint(printContent, "Ø´ÛŒÚ©Ø§Ø±ÛŒ Ú©Ø§ØªÛŒ ØºÛŒØ§Ø¨Ø§Øª");
        }

        function refreshData() {
            loadAttendanceData();
            showNotification('Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•', 'Ø¯Ø§ØªØ§Ú©Ø§Ù† Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù†ÙˆÛÚ©Ø±Ø§Ù†Û•ÙˆÛ•! ğŸ”„', 'success');
        }

        function exportTodayToExcel() {
            const tbody = document.getElementById('attendanceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length <= 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const data = [];
            const date = document.getElementById('filterDate').value || 'Ù†Ø§Ø¯ÛŒØ§Ø±';
            
            for (let row of rows) {
                if (row.cells.length > 1) {
                    data.push({
                        'Ø¨Û•Ø±ÙˆØ§Ø±': row.cells[0].textContent,
                        'Ù…Ø§Ù…Û†Ø³ØªØ§': row.cells[1].textContent,
                        'ÙˆØ§Ù†Û•': row.cells[2].textContent,
                        'Ø¦Ø§Ø³Øª': row.cells[3].textContent,
                        'Ú¯Ø±ÙˆÙˆÙ¾': row.cells[4].textContent,
                        'Ú©Ø§Øª': row.cells[5].textContent,
                        'Ø¦Ø§Ù…Ø§Ø¯Û•': row.cells[6].textContent,
                        'ØºÛŒØ§Ø¨': row.cells[7].textContent
                    });
                }
            }
            
            if (data.length === 0) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ•!', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ØºÛŒØ§Ø¨Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û†');
            XLSX.writeFile(wb, `ØªÛ†Ù…Ø§Ø±ÛŒ_ØºÛŒØ§Ø¨Ø§Øª_${date}.xlsx`);
            
            showNotification('Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ', 'ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù‡Û•Ù†Ø§Ø±Ø¯Û•Ú©Ø±Ø§! ğŸ“¥', 'success');
        }
        
        function printTodayAttendance() {
            const tbody = document.getElementById('attendanceTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length === 1 && rows[0].cells.length <= 1) {
                showNotification('Ù‡Û•ÚµÛ•', 'Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛ• Ø¨Û† Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†!', 'error');
                return;
            }
            
            const date = document.getElementById('filterDate').value || 'Ù†Ø§Ø¯ÛŒØ§Ø±';
            let tableHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            tableHTML += '<thead><tr style="background: #667eea; color: white;">';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¨Û•Ø±ÙˆØ§Ø±</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ù…Ø§Ù…Û†Ø³ØªØ§</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">ÙˆØ§Ù†Û•</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¦Ø§Ø³Øª</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú¯Ø±ÙˆÙˆÙ¾</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ú©Ø§Øª</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">Ø¦Ø§Ù…Ø§Ø¯Û•</th>';
            tableHTML += '<th style="border: 1px solid #ddd; padding: 10px;">ØºÛŒØ§Ø¨</th>';
            tableHTML += '</tr></thead><tbody>';
            
            for (let row of rows) {
                if (row.cells.length > 1) {
                    tableHTML += '<tr>';
                    for (let i = 0; i < 8; i++) {
                        tableHTML += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${row.cells[i].textContent}</td>`;
                    }
                    tableHTML += '</tr>';
                }
            }
            
            tableHTML += '</tbody></table>';
            
            const printContent = `
                <div class="print-header">
                    <div class="print-title">ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª</div>
                    <div class="print-date">Ø¨Û•Ø±ÙˆØ§Ø±: ${date}</div>
                    <div class="print-date">Ú©Ø§ØªÛŒ Ú†Ø§Ù¾: ${new Date().toLocaleString('en-GB')}</div>
                </div>
                ${tableHTML}
            `;
            
            improvedPrint(printContent, "ØªÛ†Ù…Ø§Ø±ÛŒ ØºÛŒØ§Ø¨Ø§Øª");
        }

        function logout() {
            currentUser = null;
            document.getElementById('staffDashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showNotification('Ø¯Û•Ø±Ú†ÙˆÙˆÙ†', 'Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú†ÙˆÙˆÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•! ğŸ‘‹', 'info');
        }

        window.onclick = function(event) {
            const modals = ['totalAbsenceModal', 'detailsModal', 'teachersModal', 'detailedAbsenceModal', 'timeAnalysisModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù„Û†Ú¯Û† Ú©Ø§ØªÛÚ© Ù¾Û•Ú•Û•Ú©Û• Ø¨Ø§Ø±Ú©Ø±Ø§
        document.addEventListener('DOMContentLoaded', function() {
            loadInstituteLogo();
            loadStudents();
        });
    </script>
</body>
</html>
